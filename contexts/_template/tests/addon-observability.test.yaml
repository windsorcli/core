# Note: All tests with provider: generic require cluster.controlplanes.nodes and network

# Common configurations
x-defaults:
  network: &default-network
    loadbalancer_driver: kube-vip
    loadbalancer_mode: arp
    loadbalancer_ips:
      start: "10.5.1.10"
      end: "10.5.1.100"

  cluster: &default-cluster
    controlplanes:
      nodes:
        controlplane-1:
          endpoint: 10.5.0.10:50000
          node: 10.5.0.10
          hostname: controlplane-1
    workers:
      volumes:
        - /var/local

  ingress-disabled: &ingress-disabled
    enabled: false
    driver: nginx

cases:
  - name: creates observability with Grafana dashboards and ingress in dev mode
    values:
      provider: generic
      dev: true
      dns:
        domain: example.local
      timezone: America/New_York
      time_format: 12h
      ingress:
        enabled: true
        driver: nginx
      network: *default-network
      cluster: *default-cluster
    expect:
      kustomize:
        - name: observability
          path: observability
          timeout: 15m
          interval: 10m
          components:
            - grafana
            - grafana/prometheus
            - grafana/dashboards/node
            - grafana/dashboards/kubernetes
            - grafana/dashboards/flux
            - grafana/dashboards/cert-manager
            - grafana/dashboards/nginx
          substitutions:
            external_domain: example.local
            timezone: America/New_York
            date_full: "MMM DD, YYYY @ hh:mm:ss a"
        - name: observability
          dependsOn:
            - ingress
          components:
            - grafana/ingress

  - name: uses 24h time format when specified
    values:
      provider: generic
      dev: true
      time_format: 24h
      network: *default-network
      cluster: *default-cluster
    expect:
      kustomize:
        - name: observability
          substitutions:
            date_full: "YYYY-MM-DD HH:mm:ss"
            date_interval_second: "HH:mm:ss"
            date_interval_minute: "HH:mm"
            date_interval_hour: "MM/DD HH:mm"
            date_interval_day: "MM/DD"

  - name: creates observability when addon explicitly enabled
    values:
      provider: generic
      network: *default-network
      cluster: *default-cluster
      addons:
        observability:
          enabled: true
    expect:
      kustomize:
        - name: observability
          path: observability

  - name: excludes observability when addon disabled
    values:
      provider: generic
      ingress: *ingress-disabled
      network: *default-network
      cluster: *default-cluster
      addons:
        observability:
          enabled: false
    exclude:
      kustomize:
        - name: observability

  - name: creates FluentD stdout pipeline with otel filter
    values:
      provider: generic
      network: *default-network
      cluster: *default-cluster
      addons:
        observability:
          enabled: true
          logs_driver: stdout
    expect:
      kustomize:
        - name: telemetry-resources
          dependsOn:
            - telemetry-base
          components:
            - fluentbit/fluentd
        - name: observability
          dependsOn:
            - telemetry-resources
          components:
            - fluentd
            - fluentd/filters/otel
            - fluentd/outputs/stdout

  - name: creates Quickwit storage pipeline with PVC and dashboards
    values:
      provider: generic
      network: *default-network
      cluster: *default-cluster
      addons:
        observability:
          enabled: true
          logs_driver: quickwit
    expect:
      kustomize:
        - name: observability
          dependsOn:
            - csi
            - telemetry-resources
          components:
            - fluentd
            - fluentd/filters/otel
            - fluentd/outputs/quickwit
            - quickwit
            - quickwit/pvc
            - quickwit/prometheus
            - grafana/quickwit
            - grafana/dashboards/logs/quickwit

  - name: creates ELK stack with filebeat telemetry
    values:
      provider: generic
      dns:
        domain: elk.example.com
      network: *default-network
      cluster: *default-cluster
      addons:
        observability:
          enabled: true
          logs_driver: elasticsearch
    expect:
      kustomize:
        - name: observability
          dependsOn:
            - csi
            - ingress
          components:
            - elasticsearch
            - kibana
            - kibana/ingress
          substitutions:
            external_domain: elk.example.com
        - name: telemetry-base
          strategy: replace
          components:
            - prometheus
            - prometheus/flux
            - filebeat
        - name: telemetry-resources
          strategy: replace
          components:
            - metrics-server
            - prometheus
            - prometheus/flux

  - name: creates log level filter for warn level
    values:
      provider: generic
      network: *default-network
      cluster: *default-cluster
      addons:
        observability:
          enabled: true
          logs_driver: stdout
      log_level: warn
    expect:
      kustomize:
        - name: observability
          components:
            - fluentd/filters/log-level/warn

  - name: uses default info log level filter
    values:
      provider: generic
      network: *default-network
      cluster: *default-cluster
      addons:
        observability:
          enabled: true
          logs_driver: stdout
    expect:
      kustomize:
        - name: observability
          components:
            - fluentd/filters/log-level/info

  - name: creates stdout pipeline without log filter when trace level selected
    values:
      provider: generic
      ingress: *ingress-disabled
      network: *default-network
      cluster: *default-cluster
      addons:
        observability:
          enabled: true
          logs_driver: stdout
      log_level: trace
    expect:
      kustomize:
        - name: observability
          dependsOn:
            - telemetry-resources
          components:
            - fluentd
            - fluentd/filters/otel
            - fluentd/outputs/stdout

  - name: fails when elasticsearch selected without ingress
    values:
      provider: generic
      vm:
        driver: docker-desktop
      ingress: *ingress-disabled
      network: *default-network
      cluster: *default-cluster
      addons:
        observability:
          enabled: true
          logs_driver: elasticsearch
    expectError: true
