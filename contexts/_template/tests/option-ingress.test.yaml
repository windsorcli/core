# option-ingress.yaml facet tests
# Tests configurable ingress controller with various configurations

# Common configurations
x-defaults:
  network: &default-network
    loadbalancer_driver: kube-vip
    loadbalancer_mode: arp
    loadbalancer_ips:
      start: "10.5.1.10"
      end: "10.5.1.100"

  cluster: &default-cluster
    controlplanes:
      nodes:
        controlplane-1:
          endpoint: 10.5.0.10:50000
          node: 10.5.0.10
          hostname: controlplane-1
    workers:
      volumes:
        - /var/local

cases:
  # Minimal: Standard ingress without coredns
  - name: standard ingress without coredns
    values:
      provider: metal
      ingress:
        enabled: true
        driver: nginx
      network: *default-network
      cluster: *default-cluster
    expect:
      kustomize:
        - name: ingress
          path: ingress
          dependsOn:
            - pki-base
          components:
            - nginx
            - nginx/web
            - nginx/prometheus
          timeout: 10m
          interval: 5m

  # Full: Ingress with private DNS (includes coredns)
  - name: ingress with private DNS includes coredns
    values:
      provider: metal
      ingress:
        enabled: true
        driver: nginx
      addons:
        private_dns:
          enabled: true
      network: *default-network
      cluster: *default-cluster
    expect:
      kustomize:
        - name: ingress
          path: ingress
          dependsOn:
            - pki-base
          components:
            - nginx
            - nginx/coredns
            - nginx/web
            - nginx/prometheus
          timeout: 10m
          interval: 5m

  # Edge case: Docker Desktop uses nodeport
  - name: Docker Desktop uses nodeport ingress
    values:
      provider: metal
      ingress:
        enabled: true
        driver: nginx
      vm:
        driver: docker-desktop
      network: *default-network
      cluster: *default-cluster
    expect:
      kustomize:
        - name: ingress
          path: ingress
          dependsOn:
            - pki-base
          components:
            - nginx
            - nginx/nodeport
            - nginx/web
            - nginx/prometheus
          timeout: 10m
          interval: 5m

  # Edge case: Ingress disabled
  - name: excludes ingress when disabled
    values:
      provider: metal
      ingress:
        enabled: false
        driver: nginx
      network: *default-network
      cluster: *default-cluster
    exclude:
      kustomize:
        - name: ingress
