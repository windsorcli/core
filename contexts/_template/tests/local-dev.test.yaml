# Note: All tests with provider: generic require cluster.controlplanes.nodes and network

# Common configurations
x-defaults:
  network: &default-network
    loadbalancer_driver: kube-vip
    loadbalancer_mode: arp
    loadbalancer_ips:
      start: "10.5.1.10"
      end: "10.5.1.100"

  cluster: &default-cluster
    controlplanes:
      nodes:
        controlplane-1:
          endpoint: 10.5.0.10:50000
          node: 10.5.0.10
          hostname: controlplane-1
    workers:
      volumes:
        - /var/local

  ingress-disabled: &ingress-disabled
    enabled: false
    driver: nginx

cases:
  - name: configures gitops with dev credentials and computed concurrency
    values:
      provider: generic
      dev: true
      network: *default-network
      cluster:
        controlplanes:
          cpu: 8
          memory: 16
          nodes:
            controlplane-1:
              endpoint: 10.5.0.10:50000
              node: 10.5.0.10
              hostname: controlplane-1
        workers:
          volumes:
            - /var/local
      git:
        livereload:
          username: devuser
          password: devpass
    expect:
      terraform:
        - name: gitops
          inputs:
            git_username: devuser
            git_password: devpass
            webhook_token: abcdef123456
            concurrency: 4

  - name: uses empty git credentials when not specified
    values:
      provider: generic
      dev: true
      network: *default-network
      cluster: *default-cluster
    expect:
      terraform:
        - name: gitops
          inputs:
            git_username: ""
            git_password: ""
            webhook_token: abcdef123456

  - name: creates selfsigned issuer and Grafana dev config
    values:
      provider: generic
      dev: true
      network: *default-network
      cluster: *default-cluster
    expect:
      kustomize:
        - name: pki-resources
          path: pki/resources
          dependsOn:
            - pki-base
          components:
            - public-issuer/selfsigned
        - name: observability
          components:
            - grafana/dev
          substitutions:
            admin_password: grafana

  - name: uses custom Grafana admin password when specified
    values:
      provider: generic
      dev: true
      network: *default-network
      cluster: *default-cluster
      addons:
        observability:
          admin_password: supersecret
    expect:
      kustomize:
        - name: observability
          substitutions:
            admin_password: supersecret

  - name: creates demo database when demo mode enabled
    values:
      provider: generic
      dev: true
      demo: true
      network: *default-network
      cluster: *default-cluster
    expect:
      kustomize:
        - name: demo-database
          path: demo
          dependsOn:
            - database
          components:
            - database

  - name: excludes demo database when demo mode disabled
    values:
      provider: generic
      dev: true
      demo: false
      ingress: *ingress-disabled
      network: *default-network
      cluster: *default-cluster
    exclude:
      kustomize:
        - name: demo-database

  - name: uses nodeport ingress on Docker Desktop
    values:
      provider: generic
      dev: true
      vm:
        driver: docker-desktop
      ingress:
        enabled: true
        driver: nginx
      network: *default-network
      cluster: *default-cluster
    expect:
      kustomize:
        - name: ingress
          dependsOn:
            - pki-base
          components:
            - nginx/nodeport
            - nginx/prometheus
          timeout: 10m
          interval: 5m
