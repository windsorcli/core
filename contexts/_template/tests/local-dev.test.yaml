# local-dev.yaml facet tests
# Tests local development overrides for VM environments

# Common configurations
x-defaults:
  network: &default-network
    loadbalancer_driver: kube-vip
    loadbalancer_mode: arp
    loadbalancer_ips:
      start: "10.5.1.10"
      end: "10.5.1.100"

  cluster: &default-cluster
    controlplanes:
      nodes:
        controlplane-1:
          endpoint: 10.5.0.10:50000
          node: 10.5.0.10
          hostname: controlplane-1
    workers:
      volumes:
        - /var/local

  ingress-disabled: &ingress-disabled
    enabled: false
    driver: nginx

cases:
  # Minimal: Test default dev mode behavior with no optional values
  - name: minimal dev config creates gitops with empty credentials and computed concurrency
    values:
      provider: generic
      dev: true
      network: *default-network
      cluster: *default-cluster
    expect:
      terraform:
        - name: gitops
          inputs:
            git_username: ""
            git_password: ""
            webhook_token: abcdef123456
            concurrency: 2
      kustomize:
        - name: pki-resources
          path: pki/resources
          dependsOn:
            - pki-base
          components:
            - public-issuer/selfsigned

  # Full: Test all configurable dev options together
  - name: full dev config creates gitops with credentials, demo mode, custom Grafana password, and computed concurrency
    values:
      provider: generic
      dev: true
      demo: true
      network: *default-network
      cluster:
        controlplanes:
          cpu: 8
          memory: 16
          nodes:
            controlplane-1:
              endpoint: 10.5.0.10:50000
              node: 10.5.0.10
              hostname: controlplane-1
        workers:
          volumes:
            - /var/local
      git:
        livereload:
          username: devuser
          password: devpass
      addons:
        observability:
          enabled: true
          admin_password: supersecret
    expect:
      terraform:
        - name: gitops
          inputs:
            git_username: devuser
            git_password: devpass
            webhook_token: abcdef123456
            concurrency: 4
      kustomize:
        - name: pki-resources
          path: pki/resources
          dependsOn:
            - pki-base
          components:
            - public-issuer/selfsigned
        - name: observability
          components:
            - grafana/dev
          substitutions:
            admin_password: supersecret
        - name: demo-database
          path: demo
          dependsOn:
            - database
          components:
            - database

  # Edge case: Docker Desktop uses nodeport ingress
  - name: Docker Desktop uses nodeport ingress
    values:
      provider: generic
      dev: true
      vm:
        driver: docker-desktop
      ingress:
        enabled: true
        driver: nginx
      network: *default-network
      cluster: *default-cluster
    expect:
      kustomize:
        - name: ingress
          dependsOn:
            - pki-base
          components:
            - nginx/nodeport
            - nginx/prometheus
          timeout: 10m
          interval: 5m

  # Edge case: Demo mode disabled
  - name: excludes demo database when demo mode disabled
    values:
      provider: generic
      dev: true
      demo: false
      ingress: *ingress-disabled
      network: *default-network
      cluster: *default-cluster
    exclude:
      kustomize:
        - name: demo-database
