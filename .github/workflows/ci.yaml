name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  # Blueprint Checks
  checks:
    uses: windsorcli/blueprint/.github/workflows/checks.yaml@37a5386198caa29f87531d09003512adc5407702 # v0.1.0

  checkov:
    uses: windsorcli/blueprint/.github/workflows/checkov.yaml@37a5386198caa29f87531d09003512adc5407702 # v0.1.0

  ci:
    runs-on: ubuntu-latest

    env:
      KUBECONFIG: ${{ github.workspace }}/contexts/local/.kube/config
      TALOSCONFIG: ${{ github.workspace }}/contexts/local/.talos/config
      PRIVATE_DOMAIN_NAME: private.test
      DNS_SERVER_IP: "10.5.255.200"
      WINDSOR_VERSION: "v0.3.2"

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Create .docker-cache directory
        run: mkdir -p .docker-cache

      - name: Cache .docker-cache
        uses: actions/cache@6849a6489940f00c2f30c0fb92c6274307ccb58a # v4.1.2
        with:
          path: .docker-cache
          key: docker-cache-${{ runner.os }}-${{ github.sha }}
          restore-keys: docker-cache-${{ runner.os }}-

      - name: Install Aqua
        uses: aquaproj/aqua-installer@e2d0136abcf70b7a2f6f505720640750557c4b33 # v3.1.1
        with:
          aqua_version: v2.43.0

      - name: Install tools
        run: aqua install
      
      - name: Install Windsor CLI
        run: |
          set -e
          curl -L -o windsor_${WINDSOR_VERSION#v}_linux_amd64.tar.gz https://github.com/windsorcli/cli/releases/download/${WINDSOR_VERSION}/windsor_${WINDSOR_VERSION#v}_linux_amd64.tar.gz && \
          sudo tar -xzf windsor_${WINDSOR_VERSION#v}_linux_amd64.tar.gz -C /usr/local/bin && \
          sudo chmod +x /usr/local/bin/windsor
          
      - name: Windsor Init
        run: |
          set -e
          windsor version
          windsor init local

      - name: Disable DNS
        run: |
          set -e
          echo "Disabling DNS in windsor.yaml"
          sed -i '/dns:/!b;n;c\      enabled: false' windsor.yaml
          cat windsor.yaml

      - name: Windsor Up
        run: |
          set -e
          windsor context get
          windsor up --verbose
          
      - name: Verify Kubernetes Nodes
        run: |
          set -e
          windsor exec -- kubectl get nodes
          windsor exec -- kubectl get pods -A
          windsor exec -- bash -c 'kubectl get pods -A -o json | jq -r ".items[] | select(.status.phase != \"Running\") | .metadata.name" | wc -l' | grep -q '^0$' || (echo "Not all pods are in ready state" && exit 1)

      - name: Windsor Down
        run: |
          set -e
          windsor down --clean

          