name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: read
  security-events: write
  checks: write

env:
  WINDSOR_PROJECT_ROOT: ${{ github.workspace }}
  DOCKER_HOST: unix:///var/run/docker.sock
  # renovate: datasource=github-releases depName=docker-compose package=docker/compose
  DOCKER_COMPOSE_VERSION: v2.36.0

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Docker Compose
        run: |
            sudo curl -L "https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
            docker-compose --version
        continue-on-error: false

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.x'

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          # renovate: datasource=github-releases depName=terraform package=hashicorp/terraform
          terraform_version: 1.12.0
  
      - name: Setup kubectl
        uses: azure/setup-kubectl@3e0aec4d80787158d308d7b364cb1b702e7feb7f # v4.0.0
        with:
          # renovate: datasource=github-releases depName=kubectl package=kubernetes/kubectl
          version: v1.33.0

      - name: Install Windsor CLI
        uses: windsorcli/action@main
        with:
          ref: main
          context: local

      - name: Run yamllint
        run: |
          pip install yamllint
          yamllint .

      - name: Run shellcheck
        run: |
          sudo apt-get install -y shellcheck
          find . -name "*.sh" -print0 | xargs -0 shellcheck

      - name: Run terraform fmt
        run: terraform fmt -check -recursive

      - name: Run Terraform Tests
        run: |
          find terraform -type f -name '*.tftest.hcl' | while read testfile; do
            testdir=$(dirname "$testfile")
            (cd "$testdir" && terraform init -input=false && terraform test)
          done

      - name: Create .docker-cache directory
        run: mkdir -p .windsor/.docker-cache

      - name: Cache .docker-cache
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: .windsor/.docker-cache
          key: docker-cache-${{ runner.os }}-${{ github.sha }}
          restore-keys: docker-cache-${{ runner.os }}-

      - name: Windsor Up
        run: |
          windsor init local --set dns.enabled=false
          windsor up --install --verbose

      - name: Windsor Down
        run: |
          windsor down --clean

  checkov:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Checkov GitHub Action
        uses: bridgecrewio/checkov-action@de75ec2538b4dee22a8d1db76c8bb759d015e18d # v12.3012.0
        with:
          directory: ./terraform
          output_format: cli,sarif
          output_file_path: console,results.sarif

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@60168efe1c415ce0f5521ea06d5c2062adbeed1b # v3.28.17
        with:
          sarif_file: results.sarif
